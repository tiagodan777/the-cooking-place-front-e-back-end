{% extends 'layout.html' %}
{% block title %} O que está a acontecer? {% endblock %}
{% block content %}
<main id="whats-happening">
    <h1 id="o-que-esta-a-acontecer">O que está a acontecer?</h1>
    <section id="todos-videos">
        {% for quik in quiks %}
            <div class="video-individual">
                {% if quik.receita_acoplada_id == 0 %}
                    <iframe id="video-{{ quik.id }}" class="youtube-video" src="https://www.youtube.com/embed/{{ quik.youtube_id }}?enablejsapi=1&mute=1&modestbranding=1&rel=0&showinfo=0" frameborder="0" allowfullscreen></iframe>
                    
                    <a href="{{ doc_root }}whats-happening/{{ quik.id }}/{{ quik.seo_title }}"></a>
                {% else %}
                    <iframe id="video-{{ quik.id }}" class="youtube-video" src="https://www.youtube.com/embed/{{ quik.youtube_id }}?enablejsapi=1&mute=1&modestbranding=1&rel=0&showinfo=0" frameborder="0" allowfullscreen></iframe>
                    
                    <a href="{{ doc_root }}whats-happening/{{ quik.id }}/{{ quik.seo_title }}""></a>
                </div>
                {% endif %}
                <nav id="navegacao_{{ i }}">
                    <ul>
                        <li><a href="#"><img src="{{ doc_root }}imagens/icons/banana-icon.png" alt="Ícone de banana"></a><p>20 mil</p></li>
                        <li><a href="#"><span class="material-symbols-outlined">thumb_down</span></a><p>20 mil</p></li>
                        <li><a href="#"><span class="material-symbols-outlined">chat</span></a><p>20 mil</p></li>
                        <li><a href="#"><span class="material-symbols-outlined">send</span></a><p>20 mil</p></li>
                        <li><a href="{{ doc_root }}profile{{ quik.membro_id }}/{{ quik.seo_name }}"><img src="{{ doc_root }}imagens/fotos-perfil/{{ quik.picture }}" alt="Foto de Perfil de {{ quik.autor }}"></a></li>
                    </ul>
                </nav>
                <div id="info">
                    <h1>{{ quik.titulo }}</h1>
                    {% if quik.receita_acoplada_id == 0 %}
                        <p>{{ quik.descricao }}</p>
                    {% else %}
                        <a href="{{ doc_root }}article/{{ quik.receita_acoplada_id }}">{{ quik.descricao }}</a> 
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </section>
</main>
<script>
    function atualizarTamanho() {
        let largura = window.innerWidth;
        let altura = window.innerHeight;

        for (let id = 1; id <= 3; id++) {
            let video = window.document.querySelector(`video#video_${id}`)

            video.style.width = `${largura}px`
            video.style.height = `${altura}px`
        }
    }

    function atualizarPosicao() {
        let largura = window.innerWidth;
        let altura = window.innerHeight;

        for (let id = 1; id <= 3; id++) {
            let nav = window.document.querySelector(`nav#navegacao_${id}`)

            let top = altura - 225
            let left = largura - 35
            nav.style.top = `${top}px`
            nav.style.left = `${left}px`
        }
    }

    let tag = window.document.createElement('script')
        tag.src = "https://www.youtube.com/iframe_api"
        window.document.head.appendChild(tag)
    
        const players = {}; // Certifique-se de declarar isso fora da função

        function onYouTubeIframeAPIReady() {
            document.querySelectorAll('.youtube-video').forEach(iframe => {
                const id = iframe.id;
                const videoId = iframe.dataset.videoId;

                players[id] = new YT.Player(id, {
                    videoId: videoId,
                    playerVars: {
                        modestbranding: 1,
                        rel: 0,
                        autoplay: 0,
                        loop: 0 // Aqui estamos usando loop via JS, então não precisa
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': function (e) {
                            if (e.data === YT.PlayerState.ENDED) {
                                players[id].seekTo(0);
                                players[id].playVideo();
                            }
                        }
                    }
                });
            });
        }
    
        function onPlayerReady(event) {
            const player = event.target
            const iframe = player.getIframe()
    
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        player.seekTo(0, true)
                        player.playVideo()
                    } else {
                        player.pauseVideo()
                    }
                })
            }, {
                threshold: 0.5
            })
            observer.observe(iframe)
        }
</script>
{% endblock %}
