{% extends 'layout.html' %}
{% block title %} Notificações {% endblock %}
{% block content %}
<main id="notifications">
    <h1>Notificações</h1>
    {% for notificacao in notificacoes %}
        {% if notificacao.mensagem == 'começou a seguir-te' %}
            {% set link = 'profile/' ~ notificacao.emissor_id ~ '/' ~ session.seo_name %}
        {% elseif notificacao.mensagem == 'publicou uma receita' or notificacao.mensagem == 'gostou da tua receita' %}
            {% set link = 'article/' ~ notificacao.emissor_id %}
        {% endif %}
        <div>
            <a href="{{ doc_root }}{{ link }}">
                <section id="perfil">
                    <div>
                        <img src="{{ doc_root }}imagens/fotos-perfil/{{ notificacao.picture ?? 'blank.png' }}" alt="Foto perfil de {{ notificacao.emissor }} ?>">
                    </div>
                </section>
                <section id="informacao">
                    <p id="notificacao"><span class="perfil">{{ notificacao.emissor }}</span> {{ notificacao.mensagem }}</p>
                </section>
            </a>
            <section id="seguir">
                {% if notificacao.mensagem == 'começou a seguir-te' %}
                    <a href="profile.php?id={{ notificacao.emissor_id }}">Seguir</a>
                {% endif %}
            </section>
        </div>
    {% endfor %}
</main>
<script>
    let conn  = new WebSocket("ws://localhost:8080")

    conn.onopen = function() {
        console.log('WebSocket Connected!')
    }

    conn.onmessage = function (event) {
        let data = JSON.parse(event.data)

        if (data.type === 'notification') {
            updateNotifications(data.notifications)
        }
    }

    function updateNotifications(notifications) {
         let notificationList = window.document.querySelector('p#notificacao')

         notificationList.innerHTML = ''

         if (notifications.lenght === 0) {
            notificationList.innerHTML = "Não há novas notificações"
            return
         } 

         notifications.forEach(function(notification) {
             let p = window.document.createElement('p')

             p.innerHTML = `${notification.mensagem}`

             if (notification.status === 0) {
                p.style.fontWeight = 'bold'
             }
         })
    }
</script>
{% endblock %}

    